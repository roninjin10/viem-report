import { createPublicClient, http } from "viem";
import { optimismSepolia, sepolia } from "viem/chains";
import { buildProveWithdrawal } from "viem/op-stack";
import { getDisputeGame } from "./lib/viem/src/_esm/chains/opStack/actions/getDisputeGame.js";
import { test, expect } from 'vitest'

test('repro', async function main() {
  const l1 = createPublicClient({
    chain: sepolia,
    transport: http(sepolia.rpcUrls.default.http[0]),
  });

  const l2 = createPublicClient({
    chain: optimismSepolia,
    transport: http(optimismSepolia.rpcUrls.default.http[0]),
  });

  const game = await getDisputeGame(l1, {
    l2BlockNumber: BigInt(9248350),
    targetChain: optimismSepolia,
    limit: 10,
    disputeGameFactoryAddress: "0x05F9613aDB30026FFd634f38e5C4dFd30a197Fa1",
    chain: sepolia,
  });
  expect(game).toMatchInlineSnapshot(`
    {
      "extraData": "0x000000000000000000000000000000000000000000000000000000000092c176",
      "index": 183n,
      "l2BlockNumber": 9617782n,
      "metadata": "0x000000000000000065fc5f8043032b20218f7833ac89040c943fdfe68408b0cc",
      "rootClaim": "0xeb3c8c62b6c049959d9ddfdd7208dc971fa1fb7dd6c677ddcc135dac2bdbf1e3",
      "timestamp": 1711038336n,
    }
  `)

  const args = await buildProveWithdrawal(l2, {
    game,
    withdrawal: {
      nonce:
        1766847064778384329583297500742918515827483896875618958121606201292621636n,
      sender: "0x4200000000000000000000000000000000000007",
      target: "0x58Cc85b8D04EA49cC6DBd3CbFFd00B4B8D6cb3ef",
      value: 10000000000000n,
      gasLimit: 491310n,
      data: "0xd764ad0b00010000000000000000000000000000000000000000000000000000000007000000000000000000000000004200000000000000000000000000000000000010000000000000000000000000fbb0621e0b23b5478b630bd55a5f21f67730b0f1000000000000000000000000000000000000000000000000000009184e72a0000000000000000000000000000000000000000000000000000000000000030d4000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000c41635f5fd0000000000000000000000004444d38c385d0969c64c4c8f996d7536d16c28b90000000000000000000000004444d38c385d0969c64c4c8f996d7536d16c28b9000000000000000000000000000000000000000000000000000009184e72a0000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000b737570657262726964676500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
      withdrawalHash:
        "0x8112d297788a17191e7239a03b6e93ae18c3d9f35f6f60cf52983434d54de9f2",
    },
    portalAddress: "0x16Fc5058F25648194471939df75CF27A2fdC48BC",
    disputeGameFactoryAddress: "0x05F9613aDB30026FFd634f38e5C4dFd30a197Fa1",
  });
  expect(args).toMatchInlineSnapshot(`
    {
      "account": undefined,
      "l2OutputIndex": 183n,
      "outputRootProof": {
        "latestBlockhash": "0x80c34dac5fa599ca6955f400fc1f270260309007882ed9ba7d182cfdd8edc77a",
        "messagePasserStorageRoot": "0xc2795fafea8bd97829db8e5bae9bd722f0c77bd9a2f4f2307050cf0ea9c437ec",
        "stateRoot": "0x695c4eb2ad58e1dfe4d02f3b94119abcc5aaecc2d208e9799761b4adc3e7bf2c",
        "version": "0x0000000000000000000000000000000000000000000000000000000000000000",
      },
      "targetChain": {
        "blockExplorers": {
          "default": {
            "apiUrl": "https://optimism-sepolia.blockscout.com/api",
            "name": "Blockscout",
            "url": "https://optimism-sepolia.blockscout.com",
          },
        },
        "contracts": {
          "disputeGameFactory": {
            "11155111": {
              "address": "0x05F9613aDB30026FFd634f38e5C4dFd30a197Fa1",
            },
          },
          "gasPriceOracle": {
            "address": "0x420000000000000000000000000000000000000F",
          },
          "l1Block": {
            "address": "0x4200000000000000000000000000000000000015",
          },
          "l1StandardBridge": {
            "11155111": {
              "address": "0xFBb0621E0B23b5478B630BD55a5f21f67730B0F1",
            },
          },
          "l2CrossDomainMessenger": {
            "address": "0x4200000000000000000000000000000000000007",
          },
          "l2Erc721Bridge": {
            "address": "0x4200000000000000000000000000000000000014",
          },
          "l2OutputOracle": {
            "11155111": {
              "address": "0x90E9c4f8a994a250F6aEfd61CAFb4F2e895D458F",
            },
          },
          "l2StandardBridge": {
            "address": "0x4200000000000000000000000000000000000010",
          },
          "l2ToL1MessagePasser": {
            "address": "0x4200000000000000000000000000000000000016",
          },
          "multicall3": {
            "address": "0xca11bde05977b3631167028862be2a173976ca11",
            "blockCreated": 1620204,
          },
          "portal": {
            "11155111": {
              "address": "0x16Fc5058F25648194471939df75CF27A2fdC48BC",
            },
          },
        },
        "fees": undefined,
        "formatters": {
          "block": {
            "exclude": undefined,
            "format": [Function],
            "type": "block",
          },
          "transaction": {
            "exclude": undefined,
            "format": [Function],
            "type": "transaction",
          },
          "transactionReceipt": {
            "exclude": undefined,
            "format": [Function],
            "type": "transactionReceipt",
          },
        },
        "id": 11155420,
        "name": "OP Sepolia",
        "nativeCurrency": {
          "decimals": 18,
          "name": "Sepolia Ether",
          "symbol": "ETH",
        },
        "rpcUrls": {
          "default": {
            "http": [
              "https://sepolia.optimism.io",
            ],
          },
        },
        "serializers": {
          "transaction": [Function],
        },
        "sourceId": 11155111,
        "testnet": true,
      },
      "withdrawal": {
        "data": "0xd764ad0b00010000000000000000000000000000000000000000000000000000000007000000000000000000000000004200000000000000000000000000000000000010000000000000000000000000fbb0621e0b23b5478b630bd55a5f21f67730b0f1000000000000000000000000000000000000000000000000000009184e72a0000000000000000000000000000000000000000000000000000000000000030d4000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000c41635f5fd0000000000000000000000004444d38c385d0969c64c4c8f996d7536d16c28b90000000000000000000000004444d38c385d0969c64c4c8f996d7536d16c28b9000000000000000000000000000000000000000000000000000009184e72a0000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000b737570657262726964676500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        "gasLimit": 491310n,
        "nonce": 1766847064778384329583297500742918515827483896875618958121606201292621636n,
        "sender": "0x4200000000000000000000000000000000000007",
        "target": "0x58Cc85b8D04EA49cC6DBd3CbFFd00B4B8D6cb3ef",
        "value": 10000000000000n,
        "withdrawalHash": "0x8112d297788a17191e7239a03b6e93ae18c3d9f35f6f60cf52983434d54de9f2",
      },
      "withdrawalProof": [
        "0xf90211a0eccf299db11c05f2704d507ab6a5d30d2b683db56f37fdb4848a47e4faf035bba0a034c9e88d05f5c97c3616348cc6ffcf8fcfb32851a1166c787d1d1908f8276da0c1de64e19168b26918643f27edeed1f585cfe3c010261bdf15dda3b804713ba3a0a1795ea5439823a75eac0713fc5a87d82976935ebeac6561fd155258226f6e30a0d43d83616722ce49b2ec28a7c7c507dc9ad0b339e5b30a1686aa1eb90d89c835a06d5f5d0481f37e25d8e07e9b4ec1179fa7299d796dd66cc072fcdf937e6e4323a02ebe302b980398fc27f85acaf5a99e81f1277ae33591686441b25fa8ca44f277a095d799b562766f998d9ba2f39d7ba5281133973557f6aa334b364bd6ea100feca01a990020ec839fa278d049f599d4186fdc548e017cffa94b99484b8ba761e350a087111cbad815e60758b242c4ee814f95e3239d9171e64cb9d2bb626db6d8d30aa012b32d8bb4a50eb46497f45e76cbe95546c46e09225128e426a1f27dda24db33a017d392f3ba4d37bdce9cbe5cd8ea4715119a9f9793ebec39562eed7966967343a07ee39a1fbcfafb8f82ace908e8f3891a8841c9bfb28a2e9deae8cdc8f7b8545fa0db69b599f23472dacfc2307c066a79b8532e85236fcae4c902440f8d4178a88ba072ebc599d97a58ef6f7735e2cb63e6a63304266dd3f5f834b6bd8896ceb7985da0f9f062cde09fa34c5dd02ea55274241122680ae59b4c67b3e8c4818345000cde80",
        "0xf90211a0407e704e937f1229a05d6f1c150d2141331e020e5e876fcee31085ab421f70eaa0c3b13e02f601ba79a4c5c3a8f826c37be409ffb78bc4264cd1af74af00bc0632a0e99f1f345ca98e363c8c7ef52c339dbbbab1e3cf36fa35577f08decf12666057a082e7e9e405a2443c03b5ad0d19b6763dd518567c34f7f6abd95a173cc89f068aa0a4d73354977c95ee0580bf9b3c09e45a8365f6c2630b722fdea060dd645ff34ca032e89a6babe72fd935cb90fd36598354ce7d1612a184e6f8a01e63574a70d8dfa0ae431ab8f3c22465b31a9d52f0182eaade2232f7c5fc6a52abdd2c3788409450a003e91012856bc358c16815509c4bb90dfd9b16359291aa7ba553e11ecb8474f2a0c0a45f5f0a5721ebce4c3ccc381a54196b6b3dd1259626a0b88896b8a08c4c49a0175d82019f035945e0b6b59551be3a516383903d133f6b62a0bdf3f1652539cda0541e939c7d1b54e9afb290ea0ff8bd6a9da57706465861685b707744be908b3ba0afe5cda70ab4d025a98772dc173b1ef3ffe8cab9acd738c94546443df238b032a0c1d91aa73e6afebf1e394061a28040d834bb800735a6b32730862262a84ad62da01006437b1ada977c64a67f5e53dc35dcdf419ce3912d426f4104ff583106cdcca053288cd54c72b31a1062c1205b8f958b3dfd38e152439527808c593803123db3a0a98ad9125686838ee4874d31a4813b5c24fceff5d85643cfbd86f335b52a4e1480",
        "0xf9013180a0f0a4fbdca583efea9d8dd0bc9ab5cdcc34b1d902cb5fb86246223ceadef334d6a031d22e7a42e25838cf4ba3ea447a030080cf38d807c24f2c88287bf1eaca0477a03c2067dfb6ac2145ad6a83e90d032da5ca4a407845187f87f1ab2b47487ce560a0cf34a9e380b15ad37d161614942340a1cdc458fdcfd5e0cf17eddf5af777a6ff8080a018d337c52196bfcbf5f14984948f1b1902e588e9327e7bb9e54824f75bd7f5ed80a0fed0a8e12b25cfbaf0eaf42bb6510fd2e8edb82a88c7e16c2b59ce91e98a6090a07fcf4271c0063c1960a5ac8fd46a95a6221b19571a6c35b67b6c6a982d287a86808080a01d5ff7f331497ae471693ef6e6b5b25204317f2316c579076c40868ca35cabf9a0fc2913ac3223952cf33b2ba5e2e412ba0f4ff8ae4b9bcf2b57448f2911419ebd80",
        "0xf8518080808080808080a02d5e29207e945da2767099588634a5f36a1df0331d9c702c42670c6ea7d9341c808080808080a0112248a287d5fb2ca3a2512077950126f927d6d81b8b5dfa86f77b4d435085fe80",
        "0xe19f2029ca59171a5c967bc41f856a32c974946bf0024944af97dfba940d42067501",
      ],
    }
  `)
})
